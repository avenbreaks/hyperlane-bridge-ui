map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

upstream reth_backend {
    server 127.0.0.1:8545 max_fails=3 fail_timeout=30s;
    keepalive 64;
    keepalive_requests 1000;
    keepalive_timeout 60s;
}

upstream reth_ws_backend {
    server 127.0.0.1:8546 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream beacon_backend {
    server 127.0.0.1:5052 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

# ============================================
# Rate Limiting Zones
# ============================================
# General RPC requests
limit_req_zone $binary_remote_addr zone=rpc_light:20m rate=50r/s;
limit_req_zone $binary_remote_addr zone=rpc_medium:20m rate=20r/s;
limit_req_zone $binary_remote_addr zone=rpc_heavy:20m rate=5r/s;

# WebSocket
limit_req_zone $binary_remote_addr zone=ws_limit:10m rate=30r/s;

# Beacon API
limit_req_zone $binary_remote_addr zone=beacon_limit:10m rate=100r/s;

# Connection limits
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;
limit_conn_zone $binary_remote_addr zone=ws_conn_limit:10m;

# ============================================
# Cache Configuration (minimal for real-time data)
# ============================================
proxy_cache_path /home/blockchain/nginx-cache/rpc 
    levels=1:2 
    keys_zone=rpc_cache:100m 
    max_size=2g 
    inactive=10m 
    use_temp_path=off;

# ============================================
# Cloudflare Detection & Real IP Restoration
# ============================================
# Set real IP dari Cloudflare
set_real_ip_from 173.245.48.0/20;
set_real_ip_from 103.21.244.0/22;
set_real_ip_from 103.22.200.0/22;
set_real_ip_from 103.31.4.0/22;
set_real_ip_from 141.101.64.0/18;
set_real_ip_from 108.162.192.0/18;
set_real_ip_from 190.93.240.0/20;
set_real_ip_from 188.114.96.0/20;
set_real_ip_from 197.234.240.0/22;
set_real_ip_from 198.41.128.0/17;
set_real_ip_from 162.158.0.0/15;
set_real_ip_from 104.16.0.0/13;
set_real_ip_from 104.24.0.0/14;
set_real_ip_from 172.64.0.0/13;
set_real_ip_from 131.0.72.0/22;
set_real_ip_from 2400:cb00::/32;
set_real_ip_from 2606:4700::/32;
set_real_ip_from 2803:f800::/32;
set_real_ip_from 2405:b500::/32;
set_real_ip_from 2405:8100::/32;
set_real_ip_from 2c0f:f248::/32;
set_real_ip_from 2a06:98c0::/29;

real_ip_header CF-Connecting-IP;
real_ip_recursive on;

# Detect Cloudflare requests
map $http_cf_ray $from_cloudflare {
    default 0;
    ~.+ 1;
}

# ============================================
# RPC Method Classification
# ============================================

# Light methods (cacheable, fast)
map $request_body $is_light_method {
    default 0;
    ~*"eth_blockNumber" 1;
    ~*"eth_chainId" 1;
    ~*"eth_gasPrice" 1;
    ~*"eth_maxPriorityFeePerGas" 1;
    ~*"net_version" 1;
    ~*"web3_clientVersion" 1;
}

# Medium methods (semi-cacheable)
map $request_body $is_medium_method {
    default 0;
    ~*"eth_getBlockByNumber" 1;
    ~*"eth_getBlockByHash" 1;
    ~*"eth_getTransactionByHash" 1;
    ~*"eth_getTransactionReceipt" 1;
    ~*"eth_getBalance" 1;
    ~*"eth_getCode" 1;
    ~*"eth_getStorageAt" 1;
    ~*"eth_getTransactionCount" 1;
}

# Heavy methods (not cacheable)
map $request_body $is_heavy_method {
    default 0;
    ~*"eth_call" 1;
    ~*"eth_estimateGas" 0;
    ~*"eth_getLogs" 0;
    ~*"eth_getFilterChanges" 1;
    ~*"eth_getFilterLogs" 1;
    ~*"eth_newFilter" 1;
    ~*"eth_newBlockFilter" 1;
    ~*"eth_newPendingTransactionFilter" 1;
    ~*"eth_uninstallFilter" 1;
}

# Debug/Trace methods (untuk Blockscout)
map $request_body $is_debug_method {
    default 0;
    ~*"debug_traceTransaction" 0;
    ~*"debug_traceBlockByNumber" 0;
    ~*"debug_traceBlockByHash" 0;
    ~*"trace_block" 0;
    ~*"trace_transaction" 0;
    ~*"trace_replayTransaction" 0;
    ~*"trace_replayBlockTransactions" 0;
}

# Dangerous methods (BLOCK)
map $request_body $is_dangerous_method {
    default 0;
    ~*"admin_" 1;
    ~*"personal_unlockAccount" 1;
    ~*"personal_newAccount" 1;
    ~*"personal_importRawKey" 1;
    ~*"miner_start" 1;
    ~*"miner_stop" 1;
    ~*"miner_setGasPrice" 1;
    ~*"miner_setEtherbase" 1;
}

# Mutation methods (non-cacheable)
map $request_body $is_mutation {
    default 0;
    ~*"eth_sendRawTransaction" 1;
    ~*"eth_sendTransaction" 1;
}

# Cache bypass logic
map $request_body $should_bypass_cache {
    default 0;
}

# Combine: bypass if heavy, debug, or mutation
geo $final_cache_bypass {
    default 0;
}

# ============================================
# Log Format
# ============================================
log_format rpc_detailed '$remote_addr - $remote_user [$time_local] '
                        '"$request" $status $body_bytes_sent '
                        '"$http_referer" "$http_user_agent" '
                        'rt=$request_time uct=$upstream_connect_time '
                        'uht=$upstream_header_time urt=$upstream_response_time '
                        'cache=$upstream_cache_status '
                        'cf_ray=$http_cf_ray '
                        'cf_country=$http_cf_ipcountry';

# PUBLIC RPC SERVER (HTTP/HTTPS)
server {
    listen 443 ssl http2;
    server_name rpc.davinci.bz;
    
    # SSL Configuration
    ssl_certificate     /etc/nginx/ssl/rpc.pem;
    ssl_certificate_key /etc/nginx/ssl/rpc.key;
    
    # Security Headers
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer" always;
    
    # Hide server version
    server_tokens off;
    add_header Server "" always;
    
    # Connection limits
    limit_conn conn_limit 100;
    
    # Logging
    access_log /home/blockchain/nginx-cache/reth-access/rpc-access.log rpc_detailed buffer=32k flush=5s;
    error_log /home/blockchain/nginx-cache/reth-error/rpc-error.log warn;
    
    # Request body size
    client_max_body_size 10m;
    client_body_buffer_size 128k;
    
    # Timeouts
    client_body_timeout 30s;
    client_header_timeout 30s;
    send_timeout 60s;
    
    # Main RPC Endpoint
    location / {
        if ($is_dangerous_method = 1) {
            add_header Content-Type application/json always;
            return 403 '{"jsonrpc":"2.0","error":{"code":-32601,"message":"Method not allowed"},"id":null}';
        }
        
        limit_except POST OPTIONS {
            deny all;
        }
        
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
            add_header Access-Control-Max-Age 86400 always;
            add_header Content-Length 0 always;
            return 204;
        }
        
        # CORS headers
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "POST, OPTIONS" always;
        
        # Dynamic rate limiting based on method type
        set $rate_zone "rpc_medium";
        
        if ($is_light_method = 0) {
            set $rate_zone "rpc_light";
        }
        
        if ($is_heavy_method = 0) {
            set $rate_zone "rpc_heavy";
        }
        
        if ($is_debug_method = 0) {
            set $rate_zone "rpc_heavy";
        }
        
        # Apply rate limit
        limit_req zone=rpc_medium burst=50 nodelay;
        
        # Cache configuration
        set $skip_cache 1;  # Default: no cache untuk real-time data
        
        # Only cache light methods for very short time
        if ($is_light_method = 1) {
            set $skip_cache 0;
        }
        
        # Always bypass cache for mutations
        if ($is_mutation = 1) {
            set $skip_cache 1;
        }
        
        proxy_cache rpc_cache;
        proxy_cache_methods POST;
        proxy_cache_key "$request_body";
        proxy_cache_bypass $skip_cache;
        proxy_no_cache $skip_cache;
        proxy_cache_lock on;
        proxy_cache_lock_timeout 5s;
        proxy_cache_valid 200 1s;  # Very short cache (1 second)
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        
        # Add cache status header
        add_header X-Cache-Status $upstream_cache_status always;
        add_header X-RPC-Node "Reth" always;
        
        # Proxy settings
        proxy_pass http://reth_backend;
        proxy_http_version 1.1;
        
        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
        
        # Cloudflare headers passthrough
        proxy_set_header CF-Ray $http_cf_ray;
        proxy_set_header CF-IPCountry $http_cf_ipcountry;
        proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
        
        # Timeouts
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # Health Check
    location /health {
        access_log off;
        add_header Content-Type application/json always;
        return 200 '{"status":"healthy","service":"ethereum-rpc","timestamp":"$time_iso8601","server":"$hostname"}\n';
    }
    
    # Metrics (optional, for monitoring)
    location /metrics {
        access_log off;
        allow 127.0.0.1;
        deny all;
        
        stub_status;
    }
}

server {
    listen 443 ssl http2;
    server_name rpc-bridge.davinci.bz;

    ssl_certificate     /etc/nginx/ssl/rpc-bridge.pem;
    ssl_certificate_key /etc/nginx/ssl/rpc-bridge.key;

    proxy_cache off;
    proxy_buffering off;

    location / {

        proxy_pass http://reth_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# BEACON API SERVER
server {
    listen 443 ssl http2;
    server_name beacon.davinci.bz;
    
    # SSL Configuration
    ssl_certificate     /etc/nginx/ssl/beacon.pem;
    ssl_certificate_key /etc/nginx/ssl/beacon.key;
    
    # Security
    server_tokens off;
    add_header Server "" always;
    
    # Connection limits
    limit_conn conn_limit 100;
    
    # Logging
    access_log /home/blockchain/nginx-cache/lighthouse-access/beacon-access.log rpc_detailed buffer=32k flush=5s;
    error_log /home/blockchain/nginx-cache/lighthouse-error/beacon-error.log warn;
    
    location / {
        # Rate limiting
        limit_req zone=beacon_limit burst=200 nodelay;
        
        # Minimal caching for beacon data
        proxy_cache rpc_cache;
        proxy_cache_key "$uri$is_args$args";
        proxy_cache_valid 200 1s;
        proxy_cache_use_stale error timeout updating;
        
        proxy_pass http://beacon_backend;
        proxy_http_version 1.1;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Connection "";
        
        # Timeouts
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    location /health {
        access_log off;
        proxy_pass http://beacon_backend/lighthouse/health;
        proxy_http_version 1.1;
    }
}

# BLOCKSCOUT EXPLORER ENDPOINT (via Cloudflare)
# (No rate limits, no caching, full access)
server {
    listen 443 ssl http2;
    server_name rpc-explorer.davinci.bz;
    
    # SSL Configuration
    ssl_certificate     /etc/nginx/ssl/rpc-explorer.pem;
    ssl_certificate_key /etc/nginx/ssl/rpc-explorer.key;
    
    # Security
    server_tokens off;
    add_header Server "" always;
    
    # Logging
    access_log /home/blockchain/nginx-cache/blockscout-access/blockscout-rpc.log rpc_detailed buffer=32k flush=5s;
    error_log /home/blockchain/nginx-cache/blockscout-error/blockscout-rpc-error.log warn;
    
    # Request body size
    client_max_body_size 20m;
    client_body_buffer_size 256k;
    
    location / {
        # CORS headers
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
        
        # Handle OPTIONS preflight
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
            add_header Access-Control-Max-Age 86400 always;
            add_header Content-Length 0 always;
            return 204;
        }
        
        limit_except POST OPTIONS {
            deny all;
        }
        
        proxy_pass http://reth_backend;
        proxy_http_version 1.1;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
        
        # Cloudflare headers
        proxy_set_header CF-Ray $http_cf_ray;
        proxy_set_header CF-IPCountry $http_cf_ipcountry;
        proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
        
        # Extended timeouts for trace calls
        proxy_connect_timeout 30s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # No caching
        proxy_cache off;
    }
    
    location /health {
        access_log off;
        add_header Content-Type application/json always;
        return 200 '{"status":"healthy","service":"blockscout-rpc","timestamp":"$time_iso8601"}\n';
    }
}

# BLOCKSCOUT WEBSOCKET ENDPOINT
server {
    listen 443 ssl http2;
    server_name rpc-explorer-ws.davinci.bz;
    
    # SSL Configuration
    ssl_certificate     /etc/nginx/ssl/rpc-explorer.ws.pem;
    ssl_certificate_key /etc/nginx/ssl/rpc-explorer.ws.key;
    
    # Security
    server_tokens off;
    add_header Server "" always;
    
    # Logging
    access_log /home/blockchain/nginx-cache/blockscout-access/blockscout-ws.log rpc_detailed buffer=32k flush=5s;
    error_log /home/blockchain/nginx-cache/blockscout-error/blockscout-ws-error.log warn;
    
    location / {
        # NO rate limiting for Blockscout
        proxy_pass http://reth_ws_backend;
        proxy_http_version 1.1;
        
        # WebSocket upgrade
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Cloudflare headers
        proxy_set_header CF-Ray $http_cf_ray;
        proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
        
        # Long timeouts for WebSocket
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
        
        # Disable buffering for WebSocket
        proxy_buffering off;
        proxy_socket_keepalive on;
    }
    
    location /health {
        access_log off;
        add_header Content-Type application/json always;
        return 200 '{"status":"healthy","service":"blockscout-ws","timestamp":"$time_iso8601"}\n';
    }
}

# BLOCKSCOUT BEACON API ENDPOINT (via Cloudflare)
# (No rate limits, full access)
server {
    listen 443 ssl http2;
    server_name rpc-explorer-beacon.davinci.bz;
    
    # SSL Configuration
    ssl_certificate     /etc/nginx/ssl/rpc-beacon.pem;
    ssl_certificate_key /etc/nginx/ssl/rpc-beacon.key;
    
    # Security
    server_tokens off;
    add_header Server "" always;
    
    # Logging
    access_log /home/blockchain/nginx-cache/blockscout-access/blockscout-beacon.log rpc_detailed buffer=32k flush=5s;
    error_log /home/blockchain/nginx-cache/blockscout-error/blockscout-beacon-error.log warn;
    
    location / {
        # NO rate limiting for Blockscout
        # NO caching
        
        proxy_pass http://beacon_backend;
        proxy_http_version 1.1;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
        
        # Cloudflare headers
        proxy_set_header CF-Ray $http_cf_ray;
        proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
        
        # Timeouts
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # No caching
        proxy_cache off;
    }
    
    location /health {
        access_log off;
        proxy_pass http://beacon_backend/lighthouse/health;
        proxy_http_version 1.1;
    }
}

# ============================================
# HTTP to HTTPS Redirect
# ============================================
server {
    listen 80;
    server_name rpc.davinci.bz beacon.davinci.bz rpc-explorer.davinci.bz rpc-explorer-ws.davinci.bz rpc-explorer-beacon.davinci.bz;
    
    # Redirect to HTTPS
    return 301 https://$host$request_uri;
}